<!--
ü§ñ AI ASSISTANT INSTRUCTIONS - DYNAMIC LANGUAGE SELECTION PAGE
================================================================================

PURPOSE:
This template displays the main lessons page with language selection buttons.
It AUTOMATICALLY detects all available languages and displays them - no
hardcoding required!

HOW IT WORKS:
1. Backend (home/views.py:lessons_list) queries database for all published lessons
2. Groups lessons by language and adds metadata (native names, flags)
3. Passes 'languages_with_lessons' list to this template
4. Template loops through and creates a button for each language

TEMPLATE VARIABLES RECEIVED:
- languages_with_lessons: List of dicts, each containing:
  - name: English name (e.g., 'Spanish')
  - native_name: Native language name (e.g., 'Espa√±ol')
  - flag: Flag emoji (e.g., 'üá™üá∏')
  - lesson_count: Number of lessons available
  - lessons: QuerySet of lesson objects

BUTTON BEHAVIOR:
- Each button links to /lessons/{language_lowercase}/
- Example: "üá™üá∏ Espa√±ol" button ‚Üí /lessons/spanish/
- URL routing handled by home/urls.py

‚ö†Ô∏è CRITICAL URL ROUTING REQUIREMENT:
The URL patterns in home/urls.py MUST be in the correct order:
  1. lessons/<int:lesson_id>/     ‚Üê FIRST (specific pattern)
  2. lessons/<str:language>/      ‚Üê SECOND (general pattern)

If reversed, lesson detail pages will break! See home/urls.py for full explanation.

HOW TO ADD A NEW LANGUAGE (For AI Assistants):
1. Add metadata to LANGUAGE_METADATA in home/language_registry.py
2. Create lessons in database with language='YourLanguage'
3. This template will automatically display the new language button
4. NO template changes needed!

EXAMPLE - Adding French:
Backend: Add to LANGUAGE_METADATA: 'French': {'native_name': 'Fran√ßais', 'flag': 'üá´üá∑', 'speech_code': 'fr-FR'}
Database: Create lessons with language='French'
Result: Template automatically shows "üá´üá∑ Fran√ßais" button

RELATED FILES:
- home/views.py (lessons_list function) - Provides data
- home/urls.py - URL routing
- home/templates/lessons/lessons_by_language.html - Language-specific pages

================================================================================
-->
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lessons - Language Learning Platform</title>
    {% if IS_DEVEDU %}<base href="/proxy/8000{{ request.path }}{% if not request.path|slice:'-1:' == '/' %}/{% endif %}">{% endif %}
    <link rel="stylesheet" href="{% static 'home/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/components.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/pages.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/animations.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/utilities.css' %}">
    <style>
      .current-language-panel {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-lg);
        flex-wrap: wrap;
      }
      .current-language-flag {
        font-size: 2.5rem;
      }
      .current-language-info h3 {
        margin: 0;
        font-size: var(--text-2xl);
      }
      .language-select-group label {
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-secondary);
      }
      .language-select-group select {
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-full);
        border: 1px solid var(--gray-300);
        font-weight: 600;
        min-width: 220px;
      }
      .lessons-hero {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(16, 185, 129, 0.08));
        border-radius: var(--radius-2xl);
        padding: var(--space-2xl);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-xl);
        flex-wrap: wrap;
      }
      .language-focus {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        flex-wrap: wrap;
      }
      .language-focus .flag {
        font-size: 3rem;
      }
      .language-focus h2 {
        margin: 0;
        font-size: var(--font-size-4xl);
      }
      .language-focus .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.25em;
        font-size: var(--text-xs);
        color: var(--text-secondary);
        margin-bottom: var(--space-xs);
      }
      details.language-switcher {
        position: relative;
        min-width: 220px;
      }
      details.language-switcher summary {
        list-style: none;
        cursor: pointer;
        border: 1px solid var(--gray-200);
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-full);
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        background: #fff;
        font-weight: 600;
      }
      details.language-switcher summary::-webkit-details-marker {
        display: none;
      }
      .language-switcher-menu {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        background: #fff;
        border-radius: var(--radius-xl);
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.18);
        min-width: 240px;
        padding: var(--space-sm);
        z-index: 10;
      }
      .language-switcher-menu a {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-sm) var(--space-md);
        border-radius: var(--radius-lg);
        text-decoration: none;
        color: inherit;
        font-weight: 600;
      }
      .language-switcher-menu a:hover {
        background: rgba(59, 130, 246, 0.08);
      }
      .language-switcher-menu a.locked {
        opacity: 0.6;
      }
      .language-switcher-menu .flag {
        font-size: 1.5rem;
      }
      .language-switcher-menu .tag {
        margin-left: auto;
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }
      .lessons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--space-xl);
      }
      .lesson-card {
        text-decoration: none;
        display: block;
        padding: var(--space-xl);
        border-radius: var(--radius-2xl);
        border: 1px solid var(--gray-200);
        background: #fff;
        box-shadow: 0 15px 30px rgba(15, 23, 42, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .lesson-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.15);
      }
      .lesson-card.lesson-complete {
        border-color: #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #fff 100%);
      }
      .lesson-card h3 {
        margin: 0;
      }
      .lessons-empty {
        text-align: center;
        padding: var(--space-3xl) var(--space-2xl);
        background: rgba(59, 130, 246, 0.05);
        border-radius: var(--radius-2xl);
        border: 1px dashed rgba(59, 130, 246, 0.3);
        max-width: 720px;
        margin: var(--space-3xl) auto 0;
      }
    </style>
</head>
<body>
    {% include '_nav.html' %}

    <main class="container" style="padding-top: var(--space-3xl);">
        {% if not user.is_authenticated %}
        <!-- Guest View - Login Required -->
        <div class="text-center fade-in" style="padding: var(--space-4xl) 0;">
            <div class="empty-state">
                <div class="empty-state-icon">üîí</div>
                <h2 class="text-5xl font-black mb-lg">Premium Lessons Await</h2>
                <p class="lead mb-xl">Our interactive language lessons are exclusively available to registered members.<br>Complete your placement test to unlock personalized learning content!</p>
                <div class="flex gap-lg justify-center flex-wrap">
                    <a href="{% url 'login' %}" class="btn btn-primary btn-lg">
                        Login to Access Lessons
                    </a>
            <a href="{% url 'onboarding_welcome' %}" class="btn btn-accent btn-lg">
                        Take Placement Test
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Logged In User View -->
        <section class="lessons-hero fade-in">
          <div>
            <p class="eyebrow">Your Current Language</p>
            <div class="language-focus">
              <span class="flag">{{ selected_language_metadata.flag }}</span>
              <div>
                <h2>{{ selected_language_metadata.native_name }}</h2>
                {% if selected_language_profile and selected_language_profile.proficiency_level %}
                <p style="margin: 0; color: var(--text-secondary);">{{ selected_language_profile.get_proficiency_level_display }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% if language_dropdown %}
          <details class="language-switcher">
            <summary>
              <span>{{ selected_language_metadata.flag }}</span>
              <span>{{ selected_language_metadata.native_name }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </summary>
            <div class="language-switcher-menu">
              {% for option in language_dropdown %}
              <a href="{% if option.url %}{{ option.url }}{% else %}#{% endif %}" class="{% if option.is_active %}active{% endif %} {% if option.locked %}locked{% endif %}">
                <span class="flag">{{ option.flag }}</span>
                <span>{{ option.native_name }}</span>
                {% if option.locked %}
                <span class="tag">Locked</span>
                {% endif %}
              </a>
              {% endfor %}
            </div>
          </details>
          {% endif %}
        </section>

        {% if not selected_language_completed %}
          <div class="lessons-empty fade-in-up">
            <div class="empty-state-icon">üîí</div>
            <h3>Unlock {{ selected_language }} Lessons</h3>
            <p>Complete the {{ selected_language }} placement to personalize your experience and access every lesson.</p>
            <a href="{% url 'onboarding_welcome' %}?language={{ selected_language|urlencode }}" class="btn btn-primary btn-lg" style="margin-top: var(--space-lg);">
              Start {{ selected_language }} Onboarding
            </a>
          </div>
        {% elif not selected_language_has_lessons %}
          <div class="lessons-empty fade-in-up">
            <div class="empty-state-icon">üìö</div>
            <h3>No {{ selected_language }} Lessons Yet</h3>
            <p>Hang tight! We're preparing brand new content for {{ selected_language }}.</p>
          </div>
        {% else %}
          {% if test_progress and user.is_authenticated %}
          <div class="fade-in-up" style="margin-top: var(--space-3xl); margin-bottom: var(--space-2xl);">
            <div style="background: linear-gradient(135deg, rgba(20, 184, 166, 0.1) 0%, rgba(8, 145, 178, 0.1) 100%); border-radius: var(--radius-xl); padding: var(--space-xl); border: 2px solid var(--primary);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); flex-wrap: wrap; gap: var(--space-md);">
                <div>
                  <h3 style="margin: 0; font-size: var(--text-xl); color: var(--text-primary);">Progress to Level {{ test_progress.current_level|add:1 }} Test</h3>
                  <p style="margin: var(--space-xs) 0 0 0; color: var(--text-secondary); font-size: var(--text-sm);">
                    Completed {{ test_progress.completed }}/{{ test_progress.total }} lessons
                  </p>
                </div>
                {% if test_progress.can_take_test %}
                <a href="{% url 'module_detail' language=selected_language level=test_progress.current_level %}" class="btn btn-primary">
                  Take Test ‚Üí
                </a>
                {% elif test_progress.is_module_complete %}
                <span class="badge badge-success" style="font-size: var(--text-lg); padding: var(--space-sm) var(--space-lg);">
                  ‚úì Level Complete!
                </span>
                {% endif %}
              </div>
              <div style="background: rgba(255, 255, 255, 0.8); border-radius: var(--radius-lg); padding: var(--space-xs); margin-bottom: var(--space-sm); box-shadow: var(--shadow-sm);">
                <div style="background: var(--gradient-primary); height: 16px; border-radius: var(--radius-md); width: {{ test_progress.percentage }}%; transition: width 0.3s ease; box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);"></div>
              </div>
            </div>
          </div>
          {% endif %}
          
          {% if organized_lessons %}
          <div class="fade-in-up" style="margin-top: var(--space-3xl);">
            {% for level_group in organized_lessons.levels %}
            <div style="margin-bottom: var(--space-3xl);">
              <h2 style="font-size: var(--text-3xl); font-weight: var(--font-bold); margin-bottom: var(--space-xl); color: var(--text-primary); border-bottom: 2px solid var(--primary); padding-bottom: var(--space-md);">
                Level {{ level_group.level }}
              </h2>
              <div class="lessons-grid">
                {% for item in level_group.lessons %}
                {% if item.lesson.skill_category %}
                <a href="{% url 'lesson_by_skill' language=selected_language level=item.lesson.difficulty_level skill=item.lesson.skill_category.name %}" class="lesson-card {% if item.is_complete %}lesson-complete{% endif %}" style="position: relative;">
                {% else %}
                <a href="{% if IS_DEVEDU %}../../{{ item.lesson.id }}/{% else %}{% url 'lesson_detail' item.lesson.id %}{% endif %}" class="lesson-card {% if item.is_complete %}lesson-complete{% endif %}" style="position: relative;">
                {% endif %}
                  {% if item.is_complete %}
                  <div style="position: absolute; top: var(--space-md); right: var(--space-md); background: #10b981; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                    ‚úì
                  </div>
                  {% endif %}
                  <div style="font-size: 3rem; line-height: 1; margin-bottom: var(--space-md);">
                    {{ item.icon }}
                  </div>
                  <h3 style="margin-bottom: var(--space-xs);">{{ item.lesson.title }}</h3>
                  <p class="text-muted" style="margin-bottom: var(--space-md);">{{ item.lesson.description }}</p>
                  <div class="flex gap-sm" style="flex-wrap: wrap;">
                    <span class="badge badge-primary">Level {{ item.lesson.difficulty_level }}</span>
                    {% if item.lesson.cards.count > 0 %}
                    <span class="badge badge-outline">{{ item.lesson.cards.count }} flashcard{{ item.lesson.cards.count|pluralize }}</span>
                    {% endif %}
                    {% if item.lesson.skill_category %}
                    <span class="badge badge-outline">{{ item.lesson.skill_category.get_name_display }}</span>
                    {% endif %}
                  </div>
                </a>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
            
            {% if organized_lessons.optional_lessons %}
            <div style="margin-top: var(--space-4xl); margin-bottom: var(--space-3xl);">
              <h2 style="font-size: var(--text-3xl); font-weight: var(--font-bold); margin-bottom: var(--space-xl); color: var(--text-primary); border-bottom: 2px solid var(--primary); padding-bottom: var(--space-md);">
                Optional Lessons
              </h2>
              <div class="lessons-grid">
                {% for item in organized_lessons.optional_lessons %}
                {% if item.lesson.skill_category %}
                <a href="{% url 'lesson_by_skill' language=selected_language level=item.lesson.difficulty_level skill=item.lesson.skill_category.name %}" class="lesson-card {% if item.is_complete %}lesson-complete{% endif %}" style="position: relative;">
                {% else %}
                <a href="{% if IS_DEVEDU %}../../{{ item.lesson.id }}/{% else %}{% url 'lesson_detail' item.lesson.id %}{% endif %}" class="lesson-card {% if item.is_complete %}lesson-complete{% endif %}" style="position: relative;">
                {% endif %}
                  {% if item.is_complete %}
                  <div style="position: absolute; top: var(--space-md); right: var(--space-md); background: #10b981; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                    ‚úì
                  </div>
                  {% endif %}
                  <div style="font-size: 3rem; line-height: 1; margin-bottom: var(--space-md);">
                    {{ item.icon }}
                  </div>
                  <h3 style="margin-bottom: var(--space-xs);">{{ item.lesson.title }}</h3>
                  <p class="text-muted" style="margin-bottom: var(--space-md);">{{ item.lesson.description }}</p>
                  <div class="flex gap-sm" style="flex-wrap: wrap;">
                    <span class="badge badge-primary">Level {{ item.lesson.difficulty_level }}</span>
                    {% if item.lesson.cards.count > 0 %}
                    <span class="badge badge-outline">{{ item.lesson.cards.count }} flashcard{{ item.lesson.cards.count|pluralize }}</span>
                    {% endif %}
                    {% if item.lesson.skill_category %}
                    <span class="badge badge-outline">{{ item.lesson.skill_category.get_name_display }}</span>
                    {% endif %}
                  </div>
                </a>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
          {% else %}
          <!-- Fallback to old structure if organized_lessons is not available -->
          <div class="lessons-grid fade-in-up" style="margin-top: var(--space-3xl);">
            {% for item in selected_language_lessons %}
            {% if item.lesson.skill_category %}
            <a href="{% url 'lesson_by_skill' language=selected_language level=item.lesson.difficulty_level skill=item.lesson.skill_category.name %}" class="lesson-card {% if item.is_complete %}lesson-complete{% endif %}" style="position: relative;">
            {% else %}
            <a href="{% if IS_DEVEDU %}../../{{ item.lesson.id }}/{% else %}{% url 'lesson_detail' item.lesson.id %}{% endif %}" class="lesson-card {% if item.is_complete %}lesson-complete{% endif %}" style="position: relative;">
            {% endif %}
              {% if item.is_complete %}
              <div style="position: absolute; top: var(--space-md); right: var(--space-md); background: #10b981; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                ‚úì
              </div>
              {% endif %}
              <div style="font-size: 3rem; line-height: 1; margin-bottom: var(--space-md);">
                {{ item.icon }}
              </div>
              <h3 style="margin-bottom: var(--space-xs);">{{ item.lesson.title }}</h3>
              <p class="text-muted" style="margin-bottom: var(--space-md);">{{ item.lesson.description }}</p>
              <div class="flex gap-sm" style="flex-wrap: wrap;">
                <span class="badge badge-primary">Level {{ item.lesson.difficulty_level }}</span>
                {% if item.lesson.cards.count > 0 %}
                <span class="badge badge-outline">{{ item.lesson.cards.count }} flashcard{{ item.lesson.cards.count|pluralize }}</span>
                {% endif %}
                {% if item.lesson.skill_category %}
                <span class="badge badge-outline">{{ item.lesson.skill_category.get_name_display }}</span>
                {% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% endif %}
        {% endif %}
        {% endif %}
    </main>

    <footer>
      <p>&copy; 2025 Language Learning Platform. Empowering language learners worldwide.</p>
    </footer>

    <script>
      // Smooth scroll to language section
      function scrollToLanguage(language) {
        const element = document.getElementById('language-' + language);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Mobile menu toggle
      const navToggle = document.querySelector('.nav-toggle');
      const navCenter = document.querySelector('.nav-center');

      if (navToggle && navCenter) {
        navToggle.addEventListener('click', () => {
          navCenter.classList.toggle('active');
          navToggle.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
          if (!navToggle.contains(e.target) && !navCenter.contains(e.target)) {
            navCenter.classList.remove('active');
            navToggle.classList.remove('active');
          }
        });
      }

    </script>
</body>
</html>

{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Language Learning Platform</title>
    {% if IS_DEVEDU %}<base href="/proxy/8000{{ request.path }}{% if not request.path|slice:'-1:' == '/' %}/{% endif %}">{% endif %}
    <link rel="stylesheet" href="{% static 'home/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/components.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/pages.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/animations.css' %}">
    <link rel="stylesheet" href="{% static 'home/css/utilities.css' %}">
    <style>
      .current-language-pill {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-sm) var(--space-lg);
        background: #fff;
        border-radius: var(--radius-full);
        border: 1px solid var(--gray-200);
        box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08);
        margin-top: var(--space-md);
      }
      .current-language-pill .flag {
        font-size: 1.75rem;
      }
      .current-language-pill .details {
        display: flex;
        flex-direction: column;
        line-height: 1.3;
      }
      .current-language-pill .details span {
        margin: 0;
      }
      .current-language-pill .label {
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--text-secondary);
      }
      .current-language-pill .name {
        font-size: var(--text-lg);
        font-weight: 700;
        color: var(--text-primary);
      }
      .xp-table {
        width: 100%;
        border-collapse: collapse;
      }
      .xp-table th,
      .xp-table td {
        padding: var(--space-md) var(--space-lg);
        text-align: left;
        border-bottom: 1px solid var(--gray-200);
      }
      .xp-table tbody tr:hover {
        background: rgba(20, 184, 166, 0.08);
      }
      .xp-progress-track {
        width: 100%;
        height: 8px;
        border-radius: var(--radius-full);
        background: rgba(251, 113, 133, 0.2);
        overflow: hidden;
      }
      .xp-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b 0%, #ff9770 100%);
      }
      .language-chip-grid {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        justify-content: center;
      }
      .language-chip {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-full);
        border: 1px solid var(--gray-200);
        text-decoration: none;
        font-weight: 600;
        color: var(--text-primary);
        transition: box-shadow 0.2s ease, border-color 0.2s ease;
      }
      .language-chip:hover {
        border-color: var(--primary);
        box-shadow: 0 8px 20px rgba(20, 184, 166, 0.15);
      }
      .xp-overview-card {
        background: linear-gradient(135deg, rgba(254, 242, 242, 0.9), #fff);
        border: 1px solid rgba(251, 113, 133, 0.2);
      }
      .xp-overview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
      }
      .xp-overview-header h3 {
        margin: 0;
        font-size: var(--text-2xl);
        color: #fb7185;
      }
      .xp-overview-note {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin: 0;
      }
    </style>
  </head>
  <body>
    {% include '_nav.html' %}
    
    <main class="container" style="padding-top: var(--space-3xl);">
      <!-- Django Messages -->
      {% if messages %}
        <div class="mt-xl">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
      
      <!-- Dashboard Header with Streak -->
      <section class="dashboard-header fade-in">
        <div class="dashboard-welcome">
          <div style="flex: 1;">
            <h2 class="dashboard-title">Welcome back, {{ user.first_name }}! üëã</h2>
            <p class="dashboard-subtitle">
              {% if current_streak > 0 %}
                Keep your streak alive! You're doing great!
              {% else %}
                Ready to start your learning journey?
              {% endif %}
            </p>

            {% if current_language_metadata %}
            <div class="current-language-pill">
              <span class="flag">{{ current_language_metadata.flag }}</span>
              <div class="details">
                <span class="label">Current Language</span>
                <span class="name">{{ current_language_metadata.native_name }}</span>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Animated Streak Fire -->
          <div class="streak-fire-container">
            <div class="fire-glow {% if current_streak > 0 %}active{% endif %}"></div>
            <div class="fire-emoji {% if current_streak > 0 %}active{% else %}dead{% endif %}">üî•</div>
            <div class="streak-stats">
              <span class="streak-number">{{ current_streak }}</span>
              <span class="streak-label">Day Streak</span>
            </div>
          </div>

          <div style="text-align: center;">
            {% if user.profile %}
              <img src="{{ user.profile.get_avatar_url }}" alt="{{ user.username }}'s avatar" class="avatar avatar-2xl" style="margin-bottom: var(--space-sm);">
            {% else %}
              <img src="https://www.gravatar.com/avatar/?s=200&d=identicon" alt="{{ user.username }}'s avatar" class="avatar avatar-2xl" style="margin-bottom: var(--space-sm);">
            {% endif %}
            {% if user_profile and user_profile.has_completed_onboarding %}
              <div>
                <span class="badge badge-primary" style="font-size: var(--font-size-sm); padding: var(--space-xs) var(--space-md);">
                  {{ user_profile.get_proficiency_level_display }}
                </span>
              </div>
            {% endif %}
          </div>
        </div>
      </section>

      {% if overall_xp_row or language_stats %}
      <section class="card mt-2xl fade-in-up xp-overview-card">
        <div class="card-body">
          <div class="xp-overview-header">
            <h3>XP Overview</h3>
            <p class="xp-overview-note">Track how close you are to the next milestone</p>
          </div>
          <div style="overflow-x: auto;">
            <table class="xp-table">
              <thead>
                <tr>
                  <th>Language</th>
                  <th>Level</th>
                  <th>Total XP</th>
                  <th style="width: 240px;">Progress</th>
                </tr>
              </thead>
              <tbody>
                {% if overall_xp_row %}
                <tr>
                  <td><strong>{{ overall_xp_row.label }}</strong></td>
                  <td>{{ overall_xp_row.level }}</td>
                  <td>{{ overall_xp_row.xp|floatformat:0 }}</td>
                  <td>
                    <div class="xp-progress-track">
                      <div class="xp-progress-fill" style="width: {{ overall_xp_row.progress_percent }}%;"></div>
                    </div>
                    <div class="text-xs text-secondary mt-xxs">{{ overall_xp_row.xp_to_next }} XP to next level</div>
                  </td>
                </tr>
                {% endif %}
                {% for stat in language_stats %}
                <tr>
                  <td>
                    <div class="language-name">
                      <span style="font-size: 1.5rem;">{{ stat.flag }}</span>
                      <div>
                        <strong>{{ stat.native_name }}</strong>
                        <div class="text-xs text-secondary">{{ stat.proficiency }}</div>
                      </div>
                    </div>
                  </td>
                  <td>{{ stat.level }}</td>
                  <td>{{ stat.xp|floatformat:0 }}</td>
                  <td>
                    <div class="xp-progress-track">
                      <div class="xp-progress-fill" style="width: {{ stat.progress_percent }}%;"></div>
                    </div>
                    <div class="text-xs text-secondary mt-xxs">{{ stat.xp_to_next }} XP to next level</div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-secondary">No XP data yet. Complete a lesson to see progress!</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
      {% endif %}

      {% if daily_challenge %}
        <section class="card card-bordered fade-in-up delay-150" style="margin-top: var(--space-3xl); margin-bottom: var(--space-2xl); background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%); border: 2px solid #14b8a6;">
          <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: var(--space-lg);">
              <div style="flex: 1; min-width: 260px;">
                <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
                  <span style="font-size: 2rem;">üéØ</span>
                  <h3 class="card-title" style="margin: 0;">Daily Challenge</h3>
                </div>
                <p class="text-muted" style="margin-bottom: var(--space-sm);">{{ daily_challenge.date|date:"F j, Y" }}</p>

                {% if daily_challenge.completed %}
                  <div style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-md); background: rgba(16, 185, 129, 0.15); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                    <span style="font-size: 1.5rem;">‚úÖ</span>
                    <div>
                      <p style="font-weight: 600; color: var(--color-success); margin: 0;">Nice work!</p>
                      <p class="text-muted" style="font-size: var(--font-size-sm); margin: 0;">You earned today's {{ daily_challenge.completed_via }} bonus.</p>
                    </div>
                  </div>
                {% else %}
                  <div style="padding: var(--space-md); background: var(--surface); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
                    <p style="font-weight: 600; margin-bottom: var(--space-xs);">
                      {{ daily_challenge.primary_action.label }}
                    </p>
                    <p class="text-muted" style="font-size: var(--font-size-sm); margin: 0;">
                      {{ daily_challenge.primary_action.description }}
                    </p>
                  </div>
                {% endif %}

                <div style="display: flex; align-items: center; gap: var(--space-xs);">
                  <span>‚≠ê</span>
                  <span style="font-weight: 600; color: var(--accent);">{{ daily_challenge.xp_reward }} XP available</span>
                </div>
              </div>

              <div style="display: flex; flex-direction: column; gap: var(--space-sm); min-width: 220px;">
                {% if daily_challenge.completed %}
                  <a href="{% url 'quest_history' %}" class="btn btn-outline">
                    View History
                  </a>
                {% else %}
                  <a href="{{ daily_challenge.primary_action.cta_url }}" class="btn btn-primary btn-lg" style="display: inline-flex; align-items: center; justify-content: center; gap: var(--space-xs);">
                    <span>{{ daily_challenge.primary_action.icon }}</span>
                    <span>{{ daily_challenge.primary_action.cta_label }}</span>
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </section>
      {% endif %}
      
      <!-- Quick Actions -->
      <section class="mt-3xl">
        <h3 class="text-3xl font-bold mb-xl text-center">Quick Actions</h3>
        <div class="features-grid">
          <a href="{% url 'lessons_list' %}" class="feature-item hover-lift" style="text-decoration: none;">
            <div class="feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
              </svg>
            </div>
            <h3>Browse Lessons</h3>
            <p>Explore our catalog of interactive language lessons designed for your level.</p>
          </a>

          <a href="{% url 'progress' %}" class="feature-item hover-lift" style="text-decoration: none;">
            <div class="feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
            </div>
            <h3>View Progress</h3>
            <p>Track your learning journey with detailed statistics and achievements.</p>
          </a>

          <a href="{% url 'account' %}" class="feature-item hover-lift" style="text-decoration: none;">
            <div class="feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m-9-9h6m6 0h6"></path>
                <path d="M19.07 4.93l-4.24 4.24m0 5.66l4.24 4.24M4.93 4.93l4.24 4.24m0 5.66l-4.24 4.24"></path>
              </svg>
            </div>
            <h3>Account Settings</h3>
            <p>Update your profile, change password, and customize your experience.</p>
          </a>
        </div>
      </section>
    </main>
    
    <footer>
      <p>&copy; 2025 Language Learning Platform. Empowering language learners worldwide.</p>
    </footer>

    <script>
      // Mobile menu toggle
      const navToggle = document.querySelector('.nav-toggle');
      const navCenter = document.querySelector('.nav-center');
      
      if (navToggle && navCenter) {
        navToggle.addEventListener('click', () => {
          navCenter.classList.toggle('active');
          navToggle.classList.toggle('active');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!navToggle.contains(e.target) && !navCenter.contains(e.target)) {
            navCenter.classList.remove('active');
            navToggle.classList.remove('active');
          }
        });
      }
    </script>
  </body>
</html>